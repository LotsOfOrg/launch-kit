# Authentication


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## Imports and utils

## Quick Start

Ship Kit‚Äôs authentication module provides everything you need to add
secure authentication to your FastHTML app in minutes:

``` python
from ship_kit.auth import *
from fasthtml.common import *

# 1. Initialize the database
db = init_auth_tables()  # Creates users table with indexes

# 2. Create a new user
user = create_user(db, 'john_doe', 'john@example.com', 'secure_password123')

# 3. Authenticate users during login
user = authenticate_user(db, 'john@example.com', 'secure_password123')
if user:
    sess['auth'] = True
    sess['user'] = {'id': user['id'], 'username': user['username']}

# 4. Protect routes with authentication
beforeware = Beforeware(user_auth_before, skip=['/login', '/signup'])
app, rt = fast_app(before=beforeware)

# 5. Use validation helpers
if is_username_available(db, 'new_user'):
    # Username is available for registration
    pass
```

That‚Äôs it! Your routes are now protected and users must authenticate to
access them.

## Overview

This module provides comprehensive authentication features:

### Core Functions

<table>
<colgroup>
<col style="width: 31%" />
<col style="width: 28%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>When to Use</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#hash_password"><code>hash_password</code></a></td>
<td>Securely hash passwords with bcrypt</td>
<td>User registration/password updates</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#verify_password"><code>verify_password</code></a></td>
<td>Check if password matches hash</td>
<td>User login</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#user_auth_before"><code>user_auth_before</code></a></td>
<td>Beforeware to protect routes</td>
<td>App initialization</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#get_user_from_session"><code>get_user_from_session</code></a></td>
<td>Extract user data from session</td>
<td>Inside route handlers</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#create_auth_token"><code>create_auth_token</code></a></td>
<td>Generate secure tokens</td>
<td>Remember me/API auth</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#verify_auth_token"><code>verify_auth_token</code></a></td>
<td>Validate tokens</td>
<td>Token-based auth</td>
</tr>
</tbody>
</table>

### Database Functions

<table>
<colgroup>
<col style="width: 31%" />
<col style="width: 28%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>When to Use</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#init_auth_tables"><code>init_auth_tables</code></a></td>
<td>Create database tables and indexes</td>
<td>App startup</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#create_user"><code>create_user</code></a></td>
<td>Register new user</td>
<td>User signup</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#get_user_by_id"><code>get_user_by_id</code></a></td>
<td>Fetch user by ID</td>
<td>User profile/admin</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#get_user_by_email"><code>get_user_by_email</code></a></td>
<td>Fetch user by email</td>
<td>Login/verification</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#get_user_by_username"><code>get_user_by_username</code></a></td>
<td>Fetch user by username</td>
<td>Login/profile lookup</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#update_user"><code>update_user</code></a></td>
<td>Update user attributes</td>
<td>Profile editing</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#delete_user"><code>delete_user</code></a></td>
<td>Remove user from database</td>
<td>Account deletion</td>
</tr>
</tbody>
</table>

### Helper Functions

<table>
<colgroup>
<col style="width: 31%" />
<col style="width: 28%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>When to Use</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#authenticate_user"><code>authenticate_user</code></a></td>
<td>Verify credentials and return user</td>
<td>Login endpoint</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#check_permission"><code>check_permission</code></a></td>
<td>Verify user has required role</td>
<td>Access control</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#track_login"><code>track_login</code></a></td>
<td>Record login events</td>
<td>Security/analytics</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#is_username_available"><code>is_username_available</code></a></td>
<td>Check username uniqueness</td>
<td>Registration</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#is_email_available"><code>is_email_available</code></a></td>
<td>Check email uniqueness</td>
<td>Registration</td>
</tr>
<tr>
<td><a
href="https://LotsOfOrg.github.io/ship-kit/auth.html#validate_user_data"><code>validate_user_data</code></a></td>
<td>Validate registration data</td>
<td>Form validation</td>
</tr>
</tbody>
</table>

## Password Hashing

Launch Kit uses bcrypt for password hashing - the industry standard for
secure password storage. Our implementation uses a cost factor of 12,
providing excellent security while maintaining reasonable performance
(~200ms per hash on modern hardware).

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L29"
target="_blank" style="float:right; font-size:smaller">source</a>

### hash_password

>  hash_password (password:str)

*Hash a password using bcrypt with a cost factor of 12.*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>password</td>
<td>str</td>
<td>The password to hash</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>str</strong></td>
<td><strong>The hashed password</strong></td>
</tr>
</tbody>
</table>

<div>

> **Password Length Limitation**
>
> bcrypt has a maximum password length of 72 bytes. Passwords longer
> than this are silently truncated. For applications requiring longer
> passwords, consider hashing with SHA-256 first:
>
> ``` python
> import hashlib
> long_password = "very_long_password" * 10
> # Hash with SHA-256 first, then bcrypt
> sha_hash = hashlib.sha256(long_password.encode()).hexdigest()
> final_hash = hash_password(sha_hash)
> ```

</div>

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L38"
target="_blank" style="float:right; font-size:smaller">source</a>

### verify_password

>  verify_password (password:str, hashed:str)

*Verify a password against a bcrypt hash.*

<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>password</td>
<td>str</td>
<td>The password to verify</td>
</tr>
<tr>
<td>hashed</td>
<td>str</td>
<td>The hashed password to compare against</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>bool</strong></td>
<td><strong>True if password matches hash, False otherwise</strong></td>
</tr>
</tbody>
</table>

## User Model

Launch Kit provides a simple, dataclass-based User model that works
seamlessly with FastHTML‚Äôs MiniDataAPI.

> **Note**: While the User model is defined as a dataclass, fastlite
> returns query results as dictionaries for flexibility and performance.
> This is the expected behavior and aligns with fastlite‚Äôs design
> philosophy.

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L54"
target="_blank" style="float:right; font-size:smaller">source</a>

### User

>  User (username:str, email:str, password_hash:str, role:str='user',
>            is_active:bool=True, created_at:datetime.datetime=<factory>,
>            updated_at:datetime.datetime=<factory>, id:Optional[int]=None)

*User model for authentication.*

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L67"
target="_blank" style="float:right; font-size:smaller">source</a>

### init_auth_tables

>  init_auth_tables (db_path:str='data.db')

*Creates the users table with proper schema and indexes. Uses FastHTML‚Äôs
MiniDataAPI for simple, transparent database operations.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db_path</td>
<td>str</td>
<td>data.db</td>
<td>The path to the SQLite database file</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Database</strong></td>
<td></td>
<td><strong>The FastHTML Database instance configured with the User
table</strong></td>
</tr>
</tbody>
</table>

## User CRUD Operations

Simple, transparent database operations following MiniDataAPI patterns:

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L110"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_user

>  create_user (db:apswutils.db.Database, username:str, email:str,
>                   password:str, role:str='user', table_name:str='user')

*Create a new user in the database.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>The FastHTML Database instance</td>
</tr>
<tr>
<td>username</td>
<td>str</td>
<td></td>
<td>The unique username</td>
</tr>
<tr>
<td>email</td>
<td>str</td>
<td></td>
<td>The unique email address</td>
</tr>
<tr>
<td>password</td>
<td>str</td>
<td></td>
<td>The plain text password</td>
</tr>
<tr>
<td>role</td>
<td>str</td>
<td>user</td>
<td>The user role</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td>user</td>
<td>The table name</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Optional</strong></td>
<td></td>
<td><strong>The created user dict or None if user already
exists</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L137"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_user_by_id

>  get_user_by_id (db:apswutils.db.Database, user_id:int,
>                      table_name:str='user')

*Get user by ID.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>The FastHTML Database instance</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td></td>
<td>The user ID</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td>user</td>
<td>The table name</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Optional</strong></td>
<td></td>
<td><strong>The user dict or None if not found</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L150"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_user_by_email

>  get_user_by_email (db:apswutils.db.Database, email:str,
>                         table_name:str='user')

*Get user by email address.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>The FastHTML Database instance</td>
</tr>
<tr>
<td>email</td>
<td>str</td>
<td></td>
<td>The email address</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td>user</td>
<td>The table name</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Optional</strong></td>
<td></td>
<td><strong>The user dict or None if not found</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L161"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_user_by_username

>  get_user_by_username (db:apswutils.db.Database, username:str,
>                            table_name:str='user')

*Get user by username.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>The FastHTML Database instance</td>
</tr>
<tr>
<td>username</td>
<td>str</td>
<td></td>
<td>The username</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td>user</td>
<td>The table name</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Optional</strong></td>
<td></td>
<td><strong>The user dict or None if not found</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L172"
target="_blank" style="float:right; font-size:smaller">source</a>

### update_user

>  update_user (db:apswutils.db.Database, user_id:int,
>                   table_name:str='user', **kwargs)

*Update user attributes.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>The FastHTML Database instance</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td></td>
<td>The user ID</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td>user</td>
<td>The table name</td>
</tr>
<tr>
<td>kwargs</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Optional</strong></td>
<td></td>
<td><strong>The updated user dict or None if not found</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L201"
target="_blank" style="float:right; font-size:smaller">source</a>

### delete_user

>  delete_user (db:apswutils.db.Database, user_id:int,
>                   table_name:str='user')

*Delete a user from the database.*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>The FastHTML Database instance</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td></td>
<td>The user ID</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td>user</td>
<td>The table name</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>bool</strong></td>
<td></td>
<td><strong>True if deleted, False if not found</strong></td>
</tr>
</tbody>
</table>

## Authentication Helpers

Convenient functions for common authentication operations:

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L222"
target="_blank" style="float:right; font-size:smaller">source</a>

### check_permission

>  check_permission (user:__main__.User, required_role:str)

\*Check if a user has the required role or higher.

Role hierarchy: - ‚Äòadmin‚Äô has all permissions - ‚Äòuser‚Äô has basic
permissions - Custom roles can be added as needed\*

<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>user</td>
<td>User</td>
<td>The User object to check</td>
</tr>
<tr>
<td>required_role</td>
<td>str</td>
<td>The required role</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>bool</strong></td>
<td><strong>True if user has permission, False otherwise</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L248"
target="_blank" style="float:right; font-size:smaller">source</a>

### authenticate_user

>  authenticate_user (db:apswutils.db.Database, username_or_email:str,
>                         password:str, table_name:str='user')

*Authenticate a user by username/email and password.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>The FastHTML Database instance</td>
</tr>
<tr>
<td>username_or_email</td>
<td>str</td>
<td></td>
<td>The username or email address</td>
</tr>
<tr>
<td>password</td>
<td>str</td>
<td></td>
<td>The plain text password</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td>user</td>
<td>The table name</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Optional</strong></td>
<td></td>
<td><strong>The authenticated user dict or None if invalid
credentials</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L277"
target="_blank" style="float:right; font-size:smaller">source</a>

### track_login

>  track_login (db:apswutils.db.Database, user_id:int,
>                   ip_address:Optional[str]=None,
>                   user_agent:Optional[str]=None, table_name:str='user_logins')

\*Track user login for security and analytics using MiniDataAPI pattern.

Creates a login record with timestamp and metadata. Returns the created
login record.\*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>The FastHTML Database instance</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td></td>
<td>The user ID</td>
</tr>
<tr>
<td>ip_address</td>
<td>Optional</td>
<td>None</td>
<td>The IP address of the login</td>
</tr>
<tr>
<td>user_agent</td>
<td>Optional</td>
<td>None</td>
<td>The user agent string</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td>user_logins</td>
<td>The table name</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Dict</strong></td>
<td></td>
<td><strong>The login record</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L268"
target="_blank" style="float:right; font-size:smaller">source</a>

### UserLogin

>  UserLogin (user_id:int, ip_address:Optional[str]=None,
>                 user_agent:Optional[str]=None,
>                 login_time:datetime.datetime=<factory>, id:Optional[int]=None)

*Login tracking record for security and analytics.*

### Comparison: Raw SQL vs MiniDataAPI

<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 37%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr>
<th>Aspect</th>
<th>Current (Raw SQL)</th>
<th>Proposed (MiniDataAPI)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Table Creation</strong></td>
<td>Manual SQL with CREATE TABLE</td>
<td><code>db.create(UserLogin)</code></td>
</tr>
<tr>
<td><strong>Data Insertion</strong></td>
<td>SQL INSERT with placeholders</td>
<td><code>logins.insert(login_data)</code></td>
</tr>
<tr>
<td><strong>Return Value</strong></td>
<td>None</td>
<td>Login record dict</td>
</tr>
<tr>
<td><strong>Type Safety</strong></td>
<td>No type hints for data</td>
<td>Dataclass with types</td>
</tr>
<tr>
<td><strong>Consistency</strong></td>
<td>Different from other functions</td>
<td>Same pattern as User CRUD</td>
</tr>
<tr>
<td><strong>Database Portability</strong></td>
<td>SQLite-specific syntax</td>
<td>Works across databases</td>
</tr>
<tr>
<td><strong>Foreign Keys</strong></td>
<td>Defined in CREATE TABLE</td>
<td>Need separate index creation</td>
</tr>
</tbody>
</table>

### Migration Considerations

To migrate existing databases: 1. The table structure created by
MiniDataAPI is compatible with the existing schema 2. Foreign key
constraints would need to be added separately 3. Existing data would
remain intact

## Validation Helpers

Functions to ensure data integrity and check uniqueness:

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L306"
target="_blank" style="float:right; font-size:smaller">source</a>

### is_username_available

>  is_username_available (db:apswutils.db.Database, username:str,
>                             table_name:str='user')

*Check if username is available for registration.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>The FastHTML Database instance</td>
</tr>
<tr>
<td>username</td>
<td>str</td>
<td></td>
<td>The username to check</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td>user</td>
<td>The table name</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>bool</strong></td>
<td></td>
<td><strong>True if username is available, False if taken</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L315"
target="_blank" style="float:right; font-size:smaller">source</a>

### is_email_available

>  is_email_available (db:apswutils.db.Database, email:str,
>                          table_name:str='user')

*Check if email is available for registration.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>The FastHTML Database instance</td>
</tr>
<tr>
<td>email</td>
<td>str</td>
<td></td>
<td>The email address to check</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td>user</td>
<td>The table name</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>bool</strong></td>
<td></td>
<td><strong>True if email is available, False if taken</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L324"
target="_blank" style="float:right; font-size:smaller">source</a>

### validate_user_data

>  validate_user_data (username:str, email:str, password:str)

*Validate user registration data.*

<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>username</td>
<td>str</td>
<td>The username to validate</td>
</tr>
<tr>
<td>email</td>
<td>str</td>
<td>The email address to validate</td>
</tr>
<tr>
<td>password</td>
<td>str</td>
<td>The password to validate</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>List</strong></td>
<td><strong>The list of validation errors (empty if valid)</strong></td>
</tr>
</tbody>
</table>

## Session Management

FastHTML uses server-side sessions to maintain authentication state.
Launch Kit provides utilities to make session management simple and
secure.

### Protecting Routes with Beforeware

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L353"
target="_blank" style="float:right; font-size:smaller">source</a>

### user_auth_before

>  user_auth_before (req, sess, login_path='/login')

\*Beforeware function to check authentication status.

Following FastHTML‚Äôs standard authentication pattern: - Sets
req.scope\[‚Äòauth‚Äô\] for automatic injection in route handlers - Returns
None if authenticated (continue processing) - Returns RedirectResponse
if not authenticated\*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>req</td>
<td></td>
<td></td>
<td>The FastHTML Request object</td>
</tr>
<tr>
<td>sess</td>
<td></td>
<td></td>
<td>The FastHTML Session object</td>
</tr>
<tr>
<td>login_path</td>
<td>str</td>
<td>/login</td>
<td>The login path</td>
</tr>
</tbody>
</table>

The
[`user_auth_before`](https://LotsOfOrg.github.io/ship-kit/auth.html#user_auth_before)
follows FastHTML‚Äôs recommended authentication pattern. It sets
req.scope\[‚Äòauth‚Äô\] for automatic injection in route handlers.

### Session Schema

Launch Kit uses a consistent session schema: - `sess['auth']`: Boolean
or auth token - indicates if user is authenticated - `sess['user']`:
Dict with user data (id, username, email, role, etc.)

This separation allows flexibility while maintaining consistency:

``` python
# During login:
sess['auth'] = True  # or sess['auth'] = create_auth_token(user['id'])
sess['user'] = {
    'id': user['id'],
    'username': user['username'],
    'email': user['email'],
    'role': user['role']
}
```

Usage:

``` python
beforeware = Beforeware(
    user_auth_before,
    skip=['/login', '/signup', '/static/.*']
)

# Or with a custom login path like /auth/login:
def auth_custom_login(req, sess):
    return user_auth_before(req, sess, login_path='/auth/login')
    
beforeware = Beforeware(
    auth_custom_login,
    skip=['/auth/login', '/auth/signup', '/static/.*']
)
```

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L371"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_user_from_session

>  get_user_from_session (sess)

*Extract user data dictionary from session.*

<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>sess</td>
<td></td>
<td>The FastHTML Session object</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Optional</strong></td>
<td><strong>The user data dict or None if not
authenticated</strong></td>
</tr>
</tbody>
</table>

> Note: With FastHTML‚Äôs authentication pattern, you can also access auth
> status via the ‚Äòauth‚Äô parameter in route handlers.

### Working with User Sessions

``` python
from fasthtml.common import *
from ship_kit.auth import user_auth_before

# Configure authentication beforeware
beforeware = Beforeware(
    user_auth_before,  # Uses default /login path
    skip=[
        '/login',      # Don't require auth for login page
        '/signup',     # Don't require auth for signup
        '/static/.*',  # Static files don't need auth
        r'.*\.css',    # CSS files
        r'.*\.js'      # JavaScript files
    ]
)

# Or with custom login path:
def auth_custom_login(req, sess):
    return user_auth_before(req, sess, login_path='/auth/login')

beforeware = Beforeware(
    auth_custom_login,
    skip=['/auth/login', '/auth/signup', '/static/.*']
)

# Create app with authentication
app, rt = fast_app(before=beforeware)

# This route is protected - redirects to login if not authenticated
@rt('/')
def get(auth):  # auth is automatically injected from req.scope['auth']
    return H1(f"Welcome! You are {'authenticated' if auth else 'not authenticated'}")
```

## Authentication Tokens

Tokens enable stateless authentication for APIs and ‚Äúremember me‚Äù
functionality. Launch Kit provides simple utilities for secure token
generation and verification.

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L380"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_auth_token

>  create_auth_token (user_id:int)

*Create a secure authentication token for a user.*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>user_id</td>
<td>int</td>
<td>The user ID</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>str</strong></td>
<td><strong>The authentication token</strong></td>
</tr>
</tbody>
</table>

<div>

> **Token Storage**
>
> In production, you‚Äôd store this token in your database with an
> expiration date and associate it with the user.

</div>

------------------------------------------------------------------------

<a
href="https://github.com/LotsOfOrg/ship-kit/blob/main/ship_kit/auth.py#L389"
target="_blank" style="float:right; font-size:smaller">source</a>

### verify_auth_token

>  verify_auth_token (token:str)

*Verify an authentication token and return the user ID.*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>token</td>
<td>str</td>
<td>The authentication token</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Optional</strong></td>
<td><strong>The user ID or None if invalid</strong></td>
</tr>
</tbody>
</table>

<div>

> **Token Lookup**
>
> In production, you‚Äôd look up this token in your database and check
> expiration.

</div>

## Security Best Practices

<div>

> **Critical Security Guidelines**
>
> Following these practices is essential for maintaining a secure
> authentication system.

</div>

### üîê Password Security

<table>
<thead>
<tr>
<th>Practice</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Minimum Length</strong></td>
<td>Enforce 12+ characters</td>
</tr>
<tr>
<td><strong>Complexity</strong></td>
<td>Require mixed case, numbers, symbols</td>
</tr>
<tr>
<td><strong>Common Passwords</strong></td>
<td>Check against haveibeenpwned.com</td>
</tr>
<tr>
<td><strong>Password History</strong></td>
<td>Prevent reuse of last 5 passwords</td>
</tr>
<tr>
<td><strong>Account Lockout</strong></td>
<td>Lock after 5 failed attempts</td>
</tr>
</tbody>
</table>

### üç™ Session Security

<table>
<thead>
<tr>
<th>Practice</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Secure Cookies</strong></td>
<td><code>secure=True, httponly=True, samesite='Lax'</code></td>
</tr>
<tr>
<td><strong>Session Timeout</strong></td>
<td>30 min idle, 12 hour absolute</td>
</tr>
<tr>
<td><strong>Session Rotation</strong></td>
<td>New ID after login</td>
</tr>
<tr>
<td><strong>CSRF Protection</strong></td>
<td>Use CSRF tokens for state changes</td>
</tr>
</tbody>
</table>

### üé´ Token Security

<table>
<thead>
<tr>
<th>Practice</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Storage</strong></td>
<td>Hash tokens before storing</td>
</tr>
<tr>
<td><strong>Expiration</strong></td>
<td>30 days for remember me</td>
</tr>
<tr>
<td><strong>Rotation</strong></td>
<td>New token on each use</td>
</tr>
<tr>
<td><strong>Revocation</strong></td>
<td>Allow users to revoke all tokens</td>
</tr>
</tbody>
</table>

### üåê General Security

<table>
<thead>
<tr>
<th>Practice</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>HTTPS</strong></td>
<td>Enforce TLS 1.2+ everywhere</td>
</tr>
<tr>
<td><strong>Rate Limiting</strong></td>
<td>5 attempts per minute</td>
</tr>
<tr>
<td><strong>Audit Logging</strong></td>
<td>Log all auth events</td>
</tr>
<tr>
<td><strong>2FA</strong></td>
<td>Support TOTP/WebAuthn</td>
</tr>
</tbody>
</table>

## Complete Database Example

Here‚Äôs how to use the User model and database functions together:

``` python
from ship_kit.auth import *
from fasthtml.common import *

# Initialize database
db = init_auth_tables('app.db')

# Create FastHTML app with auth
beforeware = Beforeware(
    user_auth_before,
    skip=['/login', '/signup', '/']
)
app, rt = fast_app(before=beforeware)

@rt('/')
def get():
    return Div(
        H1('Welcome to Ship Kit Auth Demo'),
        A('Sign Up', href='/signup'),
        ' | ',
        A('Login', href='/login')
    )

@rt('/signup')
def get():
    return Div(
        H2('Sign Up'),
        Form(
            Input(name='username', placeholder='Username', required=True),
            Input(name='email', type='email', placeholder='Email', required=True),
            Input(name='password', type='password', placeholder='Password', required=True),
            Button('Sign Up', type='submit'),
            method='post'
        )
    )

@rt('/signup')
def post(username: str, email: str, password: str):
    # Validate input
    errors = validate_user_data(username, email, password)
    if errors:
        return Div(
            *[P(error, style='color: red') for error in errors],
            get()
        )
    
    # Check availability
    if not is_username_available(db, username):
        return Div(P('Username already taken', style='color: red'), get())
    if not is_email_available(db, email):
        return Div(P('Email already registered', style='color: red'), get())
    
    # Create user
    user = create_user(db, username, email, password)
    if user:
        return Redirect('/login')
    
    return Div(P('Registration failed', style='color: red'), get())

@rt('/login')
def get():
    return Div(
        H2('Login'),
        Form(
            Input(name='username_or_email', placeholder='Username or Email', required=True),
            Input(name='password', type='password', placeholder='Password', required=True),
            Button('Login', type='submit'),
            method='post'
        )
    )

@rt('/login')
def post(username_or_email: str, password: str, sess, req):
    # Authenticate user
    user = authenticate_user(db, username_or_email, password)
    
    if user:
        # Set session
        sess['auth'] = True
        sess['user'] = {'id': user['id'], 'username': user['username'], 'email': user['email']}
        
        # Track login (now returns a dictionary with login details)
        ip = req.headers.get('x-forwarded-for', req.client.host)
        user_agent = req.headers.get('user-agent')
        login_record = track_login(db, user['id'], ip, user_agent)
        
        # You can use the login_record if needed, e.g. for analytics
        # login_record contains: id, user_id, ip_address, user_agent, login_time
        
        return Redirect('/dashboard')
    
    return Div(P('Invalid credentials', style='color: red'), get())

@rt('/dashboard')
def get(auth, sess):
    user_data = get_user_from_session(sess)
    if not user_data:
        return Redirect('/login')
    
    return Div(
        H2(f"Welcome, {user_data['username']}!"),
        P(f"Email: {user_data['email']}"),
        A('Logout', href='/logout')
    )

@rt('/logout')
def get(sess):
    sess.clear()
    return Redirect('/')
```

## Database Tests

Testing the User model and database operations:

### Quick Example

### Complete Login/Signup Example

Here‚Äôs how to implement a complete authentication flow:

``` python
from fasthtml.common import *
from ship_kit.auth import hash_password, verify_password

# Initialize FastHTML app
app, rt = fast_app()

# Simulated user database
users = {}

@rt('/signup')
def post(email: str, password: str):
    # Check if user exists
    if email in users:
        return "User already exists", 400
    
    # Create new user with hashed password
    users[email] = {
        'email': email,
        'password': hash_password(password)
    }
    return "Signup successful! Please login."

@rt('/login') 
def post(email: str, password: str, sess):
    # Get user from database
    user = users.get(email)
    
    if user and verify_password(password, user['password']):
        # Set session authentication
        sess['auth'] = True
        sess['user_id'] = email
        return Redirect('/')
    
    return "Invalid credentials", 401
```

``` python
# User registration
user_password = "MySecureP@ssw0rd!"
hashed_password = hash_password(user_password)
print(f"Store this in database: {hashed_password[:20]}...")

# User login
login_attempt = "MySecureP@ssw0rd!"
if verify_password(login_attempt, hashed_password):
    print("‚úÖ Login successful!")
else:
    print("‚ùå Invalid password")

# Wrong password attempt
if not verify_password("wrong_password", hashed_password):
    print("‚ùå Invalid credentials rejected")
```

    Store this in database: $2b$12$J7K88iTYaU2pD...
    ‚úÖ Login successful!
    ‚ùå Invalid credentials rejected

### Token Usage Example

### Remember Me Implementation

Here‚Äôs how to implement ‚Äúremember me‚Äù functionality using tokens:

``` python
from fasthtml.common import *
from ship_kit.auth import *

# Initialize app
app, rt = fast_app()

# Helper functions (would be in your database module)
def get_user_by_email(email): 
    # Fetch from database
    pass

def store_remember_token(user_id, token, days): 
    # Store token with expiration in database
    pass

def is_token_valid_in_db(token): 
    # Check token validity in database
    pass

@rt('/login')
def post(email: str, password: str, remember_me: bool, sess, resp):
    user = get_user_by_email(email)
    
    if user and verify_password(password, user['password']):
        # Set session auth
        sess['auth'] = True
        sess['user_id'] = user['id']
        
        # If remember me is checked, create a token
        if remember_me:
            token = create_auth_token(user['id'])
            # Store token in database with expiration
            store_remember_token(user['id'], token, days=30)
            # Set cookie
            resp.set_cookie('remember_token', token, max_age=30*24*60*60)
        
        return Redirect('/')
    
    return "Invalid credentials"

@rt('/')
def get(sess, req):
    # Check session first
    if sess.get('auth'):
        return "Welcome back!"
    
    # Check remember me token
    token = req.cookies.get('remember_token')
    if token:
        user_id = verify_auth_token(token)
        if user_id and is_token_valid_in_db(token):
            # Restore session
            sess['auth'] = True
            sess['user_id'] = user_id
            return "Welcome back (remembered)!"
    
    return Redirect('/login')
```

``` python
# Generate a token for user 42
user_id = 42
token = create_auth_token(user_id)
print(f"Generated token: {token[:20]}...")

# Later, verify the token
verified_user_id = verify_auth_token(token)
if verified_user_id:
    print(f"‚úÖ Valid token for user {verified_user_id}")
else:
    print("‚ùå Invalid or expired token")

# Invalid tokens return None
assert verify_auth_token("tampered_token") is None
print("‚ùå Tampered tokens are rejected")
```

    Generated token: 42:l97Cko11shUwHASMC...
    ‚úÖ Valid token for user 42
    ‚ùå Tampered tokens are rejected

## Complete Example: Interactive Demo

Here‚Äôs a complete FastHTML application demonstrating all authentication
features. Run it right here in the notebook!

``` python
from fasthtml.common import *
from ship_kit.auth import *

# Simulated database
users_db = {'test@example.com': {'id': 1, 'email': 'test@example.com', 'password': hash_password('password123')}}

# Configure authentication with custom login path
# Create a wrapper function instead of using partial
def auth_with_custom_login(req, sess):
    return user_auth_before(req, sess, login_path='/auth/login')

beforeware = Beforeware(
    auth_with_custom_login,
    skip=[r'/auth/.*', r'/public/.*', '/']
)
app, rt = fast_app(before=beforeware)

# Public home page
@rt('/')
def get(): 
    return Div(
        H1('Welcome to SecureApp'),
        P('A demo of Ship Kit authentication'),
        A('Login', href='/auth/login', cls='button'),
        A('Protected Area', href='/protected', cls='button')
    )

# Login page
@rt('/auth/login')
def get():
    return Div(
        H2('Login'),
        Form(
            Input(name='email', type='email', placeholder='Email', required=True),
            Input(name='password', type='password', placeholder='Password', required=True),
            Button('Login', type='submit'),
            method='post'
        )
    )

# Handle login
@rt('/auth/login')
def post(email: str, password: str, sess):
    user = users_db.get(email)
    if user and verify_password(password, user['password']):
        sess['auth'] = True
        sess['user'] = user
        return Redirect('/protected')
    return Div(P('Invalid credentials', style='color: red'), get())

# Protected page
@rt('/protected')
def get(auth, sess):
    user = get_user_from_session(sess)
    return Div(
        H2(f"Welcome {user['email']}!"),
        P('This is a protected page.'),
        A('Logout', href='/auth/logout', cls='button')
    )

# Logout
@rt('/auth/logout')
def get(sess):
    sess.clear()
    return Redirect('/')

# Start the server in Jupyter [https://fastht.ml/docs/tutorials/jupyter_and_fasthtml.html]
from fasthtml.jupyter import JupyUvi
server = JupyUvi(app)
print("Server running at http://localhost:8000")
print("\nTest credentials:")
print("- Email: test@example.com")
print("- Password: password123")
```

<script>
document.body.addEventListener('htmx:configRequest', (event) => {
    if(event.detail.path.includes('://')) return;
    htmx.config.selfRequestsOnly=false;
    event.detail.path = `${location.protocol}//${location.hostname}:8000${event.detail.path}`;
});
</script>

    Server running at http://localhost:8000

    Test credentials:
    - Email: test@example.com
    - Password: password123

``` python
# View the app right here in the notebook by uncommenting the line below
from fasthtml.jupyter import HTMX
#HTMX()
```

### Automated Testing

You can also test the authentication flow programmatically:

``` python
import httpx
import asyncio

# Test the authentication flow
async def test_auth_flow():
    async with httpx.AsyncClient(base_url="http://localhost:8000", follow_redirects=False) as client:
        print("Testing authentication flow...")
        
        # 1. Try protected page (should redirect)
        resp = await client.get("/protected")
        assert resp.status_code == 303
        assert resp.headers['location'] == '/auth/login'
        print("‚úì Protected page redirects to /auth/login")
        
        # 2. Login with valid credentials
        resp = await client.post("/auth/login", data={
            "email": "test@example.com",
            "password": "password123"
        })
        assert resp.status_code == 303
        assert resp.headers['location'] == '/protected'
        print("‚úì Login successful")
        
        # 3. Access protected page
        resp = await client.get("/protected", follow_redirects=True)
        assert "Welcome test@example.com" in resp.text
        print("‚úì Protected page accessible")
        
        # 4. Logout
        resp = await client.get("/auth/logout")
        assert resp.status_code == 303
        print("‚úì Logout successful")
        
        print("\n‚úÖ All tests passed!")

# Run the tests
await test_auth_flow()
```

    Testing authentication flow...
    ‚úì Protected page redirects to /auth/login
    ‚úì Login successful
    ‚úì Protected page accessible
    ‚úì Logout successful

    ‚úÖ All tests passed!

### Manual Testing

You can test the app manually in a browser by visiting: -
http://localhost:8000 - Home page - http://localhost:8000/protected -
Will redirect to login - http://localhost:8000/auth/login - Login with
test@example.com / password123

``` python
# Stop the server gracefully
# Note: Always run this after testing to clean up otherwise there will be a dangling thread
# https://fastht.ml/docs/tutorials/jupyter_and_fasthtml.html#graceful-shutdowns
print("Stopping server...")
server.stop()
print("‚úì Server stopped gracefully")
print("\nüéâ All tests passed! Authentication utilities are working correctly with FastHTML.")
```

    Stopping server...
    ‚úì Server stopped gracefully

    üéâ All tests passed! Authentication utilities are working correctly with FastHTML.

## Auth Tests

## Performance Benchmarks

Understanding the performance characteristics of authentication
operations is crucial for capacity planning.

## Summary

Ship Kit‚Äôs authentication module provides a complete, secure foundation
for FastHTML applications:

- **Simple API** - Core authentication functions plus comprehensive
  database operations
- **Database Integration** - User model with FastHTML‚Äôs MiniDataAPI for
  transparent persistence
- **Secure by Default** - Industry-standard bcrypt hashing with sensible
  defaults
- **FastHTML Native** - Seamless integration with sessions, beforeware,
  and database patterns
- **Production Ready** - Battle-tested patterns with comprehensive
  security guidelines
- **Flexible** - Works for both traditional web apps and API
  authentication
- **Complete Solution** - From user registration to login tracking, all
  in one module

### Breaking Changes in v2.0

- **Consistent Session Schema** - Always use `sess['auth']` for auth
  status and `sess['user']` for user data
- **Simplified user_auth_before** - Now explicitly documents return
  behavior and sets req.scope\[‚Äòauth‚Äô\]
